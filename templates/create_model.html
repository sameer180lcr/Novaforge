{% extends 'base.html' %}
{% block title %}Create Your Own Model — NovaForge AI{% endblock %}
{% block content %}
<section class="container page-head">
  <h1>Create Your Own Model</h1>
  <p class="muted">Configure 30+ options. We’ll estimate pricing and add it to your cart.</p>
</section>
<style>
  .builder-grid{display:grid;grid-template-columns:1.4fr .8fr;gap:24px;align-items:start}
  .sticky{position:sticky;top:84px}
  .summary-list{margin:8px 0 0 0;padding:0;list-style:none}
  .summary-list li{margin:4px 0;color:var(--muted,#9aa3ae);font-size:.95rem}
  @media(max-width: 980px){.builder-grid{grid-template-columns:1fr}}
  .hint{font-size:.9rem;color:var(--muted,#9aa3ae)}
  .divider{height:1px;background:linear-gradient(90deg,transparent,#2a2f36,transparent);margin:8px 0}
  /* Enhanced cards */
  .card{backdrop-filter: blur(8px); background:rgba(20,24,30,.55); border:1px solid rgba(255,255,255,.06); box-shadow:0 8px 26px rgba(0,0,0,.25)}
  .card h2{font-size:1.35rem;letter-spacing:.2px;margin-bottom:14px}
  .grid-2, .grid-3{gap:16px}
  /* Label + controls */
  .card label{display:flex;flex-direction:column;gap:6px;font-weight:600;color:#d0d6de}
  .card label .sub{font-weight:400;color:#9aa3ae;font-size:.9rem}
  .card input[type="text"],
  .card input[type="number"],
  .card select,
  .card textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(8,12,16,.6);color:#e8eef7;outline:none;transition:.15s box-shadow,.15s border-color}
  .card textarea{min-height:88px}
  .card input[type="text"]:focus,
  .card input[type="number"]:focus,
  .card select:focus,
  .card textarea:focus{border-color:#4da3ff;box-shadow:0 0 0 3px rgba(77,163,255,.15)}
  /* Checkbox rows */
  label.checkbox{flex-direction:row;align-items:center;gap:10px;font-weight:600}
  label.checkbox input{width:18px;height:18px;accent-color:#4da3ff}
  /* Chip toggles */
  .chip-check{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:rgba(8,12,16,.45);margin:6px 8px 0 0;cursor:pointer;user-select:none;transition:.15s border-color,.15s background}
  .chip-check input{appearance:none;width:0;height:0;margin:0}
  .chip-check:has(input:checked){border-color:#4da3ff;background:rgba(77,163,255,.12)}
  /* Sidebar */
  .stat{font-size:1.05rem;margin:6px 0}
  .btn-row{display:flex;flex-direction:column;gap:10px}
  .btn-primary,.btn-secondary{padding:12px 14px;border-radius:12px;font-weight:700}
  .btn-secondary{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
  .btn-secondary:hover{background:rgba(255,255,255,.07)}
  .btn-primary{background:linear-gradient(90deg,#6ea8ff,#7f7cff);border:none}
  .btn-primary:hover{filter:brightness(1.05)}
</style>

<form class="container builder-grid" method="POST" action="{{ url_for('create_model') }}" id="builderForm">
  <div>
  <div class="card">
    <h2>Project Details</h2>
    <div class="grid-2">
      <label>Project Name
        <input type="text" name="project_name" placeholder="My Custom Model" required>
      </label>
      <label>Primary Use Case
        <input type="text" name="use_case" placeholder="E.g., customer support copilot">
      </label>
    </div>
    <label>Notes
      <textarea name="notes" rows="3" placeholder="Any important constraints, datasets, or domain notes..."></textarea>
    </label>
  </div>
  <div class="card">
    <h2>Core</h2>
    <div class="grid-2">
      <label>Framework
        <select name="framework" required>
          {% for f in options.frameworks %}<option value="{{ f }}">{{ f }}</option>{% endfor %}
        </select>
      </label>
      <label>Model Size
        <select name="size" required>
          {% for s in options.sizes %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
        </select>
      </label>
      <label>Modality
        <select name="modality">
          {% for m in options.modalities %}<option value="{{ m }}">{{ m }}</option>{% endfor %}
        </select>
      </label>
      <label>Context Window
        <select name="context">
          {% for c in options.contexts %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
        </select>
      </label>
      <label>Quantization
        <select name="quantization">
          {% for q in options.quantizations %}<option value="{{ q }}">{{ q }}</option>{% endfor %}
        </select>
      </label>
      <label>Tokenizer
        <select name="tokenizer">
          {% for t in options.tokenizers %}<option value="{{ t }}">{{ t }}</option>{% endfor %}
        </select>
      </label>
    </div>
  </div>

  <div class="card">
    <h2>Training & Alignment</h2>
    <div class="grid-3">
      <label>Finetuning
        <select name="finetune">
          {% for ft in options.finetunes %}<option value="{{ ft }}">{{ ft }}</option>{% endfor %}
        </select>
      </label>
      <label class="checkbox"><input type="checkbox" name="rlhf"> RLHF</label>
      <label class="checkbox"><input type="checkbox" name="safety"> Safety Filters</label>
      <label class="checkbox"><input type="checkbox" name="multilingual"> Multilingual</label>
    </div>
  </div>

  <div class="card">
    <h2>Retrieval & Tools</h2>
    <div class="grid-3">
      <label class="checkbox"><input type="checkbox" name="retrieval"> Retrieval Augmentation</label>
      <label>Vector DB
        <select name="vectordb">
          {% for v in options.vectordbs %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
        </select>
      </label>
      <label class="checkbox"><input type="checkbox" name="function_calling"> Function Calling</label>
      <label class="checkbox"><input type="checkbox" name="tools"> Tool Use</label>
      <label class="checkbox"><input type="checkbox" name="streaming"> Streaming Responses</label>
      <label>SDKs<br>
        {% for s in options.sdks %}
          <label class="chip-check"><input type="checkbox" name="sdks" value="{{ s }}"> {{ s|capitalize }}</label>
        {% endfor %}
      </label>
    </div>
  </div>

  <div class="card">
    <h2>Data Sources (Scraping)</h2>
    <div class="grid-3">
      <label>Text Sources <span class="sub">(+$8,000 each)</span><br>
        {% for s in options.scrape_text %}
          <label class="chip-check"><input type="checkbox" name="scrape_text" value="{{ s }}"> {{ s|capitalize }}</label>
        {% endfor %}
      </label>
      <label>Image Sources <span class="sub">(+$5,000 each)</span><br>
        {% for s in options.scrape_image %}
          <label class="chip-check"><input type="checkbox" name="scrape_image" value="{{ s }}"> {{ s|capitalize }}</label>
        {% endfor %}
      </label>
      <div class="hint">We’ll provision compliant crawlers and pipelines for collection, cleaning, and deduplication.</div>
    </div>
  </div>

  <div class="card">
    <h2>Serving</h2>
    <div class="grid-3">
      <label>Batch Size
        <input type="number" name="batch_size" value="8" min="1" max="1024">
      </label>
      <label>Target Latency (ms)
        <input type="number" name="latency" value="300" min="50" max="5000">
      </label>
      <label>Target Throughput (RPS)
        <input type="number" name="throughput" value="50" min="1" max="10000">
      </label>
      <label>GPU Type
        <select name="gpu">
          {% for g in options.gpus %}<option value="{{ g }}">{{ g }}</option>{% endfor %}
        </select>
      </label>
      <label>Regions<br>
        {% for r in options.regions %}
          <label class="chip-check"><input type="checkbox" name="regions" value="{{ r }}"> {{ r }}</label>
        {% endfor %}
      </label>
      <label>Endpoints<br>
        {% for e in options.endpoints %}
          <label class="chip-check"><input type="checkbox" name="endpoints" value="{{ e }}"> {{ e }}</label>
        {% endfor %}
      </label>
    </div>
  </div>

  <div class="card">
    <h2>Security & Compliance</h2>
    <div class="grid-3">
      <label>Auth Method
        <select name="auth">
          {% for a in options.auth %}<option value="{{ a }}">{{ a }}</option>{% endfor %}
        </select>
      </label>
      <label>Compliance<br>
        {% for c in options.compliance %}
          <label class="chip-check"><input type="checkbox" name="compliance" value="{{ c }}"> {{ c }}</label>
        {% endfor %}
      </label>
      <label class="checkbox"><input type="checkbox" name="logging"> Audit Logging</label>
      <label class="checkbox"><input type="checkbox" name="monitoring"> Monitoring</label>
      <label class="checkbox"><input type="checkbox" name="autoscale"> Autoscale</label>
      <label>SLA
        <select name="sla">
          {% for s in options.sla %}<option value="{{ s }}">{{ s|capitalize }}</option>{% endfor %}
        </select>
      </label>
      <label>Budget Tier
        <select name="budget">
          {% for b in options.budget %}<option value="{{ b }}">{{ b|capitalize }}</option>{% endfor %}
        </select>
      </label>
    </div>
  </div>
  </div>

  <aside>
    <div class="card sticky">
      <h2>Estimate</h2>
      <div class="stat">Estimated Price: <strong id="estPrice">$70000.00</strong></div>
      <div class="stat">Build Time: <strong id="estDays">~45 days</strong></div>
      <div class="divider"></div>
      <div class="hint">Selected summary</div>
      <ul class="summary-list" id="selSummary">
        <li>Framework: —</li>
        <li>Size: —</li>
        <li>Modality: —</li>
        <li>Quantization: —</li>
        <li>Finetune: —</li>
        <li>GPU: —</li>
      </ul>
      <div class="divider"></div>
      <div class="btn-row">
        <button type="submit" name="action" value="generate" class="btn-secondary" style="width:100%">Generate Build Plan</button>
        <button type="submit" name="action" value="add_to_cart" class="btn-primary" style="width:100%">Add to cart</button>
      </div>
      <p class="hint" style="margin-top:8px">Estimate updates live. Final totals compute on submit.</p>
    </div>
  </aside>
</form>

<script>
(function(){
  const form = document.getElementById('builderForm');
  const est = document.getElementById('estPrice');
  function val(name){
    const el = form.elements[name];
    if(!el) return null;
    if(el instanceof RadioNodeList){ return el.value; }
    return el.value;
  }
  function checked(name){ return !!form.elements[name]?.checked; }
  function list(name){ return Array.from(form.querySelectorAll(`[name="${name}"]:checked`)).map(e=>e.value); }
  function recalc(){
    let price = 70000.0;
    const size = val('size');
    const context = parseInt(val('context')||'4096');
    const quant = val('quantization');
    const finetune = val('finetune');
    const rlhf = checked('rlhf');
    const retrieval = checked('retrieval');
    const multilingual = checked('multilingual');
    const streaming = checked('streaming');
    const function_calling = checked('function_calling');
    const tools = checked('tools');
    const latency = parseInt(val('latency')||'300');
    const throughput = parseInt(val('throughput')||'50');
    const gpu = val('gpu');
    const regions = list('regions');
    const compliance = list('compliance');
    const endpoints = list('endpoints');
    const sdks = list('sdks');
    const sla = val('sla');
    const budget = val('budget');
    const framework = val('framework');
    const modality = val('modality');
    const scrapeText = list('scrape_text');
    const scrapeImage = list('scrape_image');

    const sizeMap = {"1B":0,"7B":20000,"13B":40000,"34B":90000,"70B":180000};
    price += (sizeMap[size]||0);
    if(context>4096){ price += ((context-4096)/1024)*500; }
    if(['FP16','FP32'].includes(quant)){ price += 1000; }
    if(finetune==='Full'){ price += 30000; }
    if(['LoRA','QLoRA'].includes(finetune)){ price += 12000; }
    if(rlhf){ price += 25000; }
    if(retrieval){ price += 12000; }
    if(multilingual){ price += 9000; }
    if(streaming){ price += 4000; }
    if(function_calling){ price += 6000; }
    if(tools){ price += 4000; }
    if(latency<150){ price += 20000; }
    if(throughput>100){ price += 15000; }
    if(gpu==='H100'){ price += 18000; }
    price += 8000 * regions.length;
    price += 10000 * compliance.length;
    if(checked('autoscale')){ price += 6000; }
    price += 3000 * endpoints.length;
    price += 3000 * sdks.length;
    if(sla==='premium'){ price += 12000; }
    if(budget==='enterprise'){ price += 25000; }
    // Scraping costs
    price += 8000 * scrapeText.length;
    price += 5000 * scrapeImage.length;
    est.textContent = `$${price.toFixed(2)}`;
    // Build days estimate (mirror server premium logic)
    let days = 45; // premium base
    const sizeDays = {"1B":0,"7B":10,"13B":20,"34B":30,"70B":40};
    days += (sizeDays[size]||0);
    if(context>4096){ days += Math.floor((context-4096)/4096)*5; }
    if(finetune==='Full'){ days += 25; } else if(['LoRA','QLoRA'].includes(finetune)){ days += 12; }
    if(rlhf){ days += 20; }
    if(retrieval){ days += 10; }
    if(multilingual){ days += 8; }
    if(streaming){ days += 4; }
    if(function_calling){ days += 6; }
    if(tools){ days += 5; }
    if(latency<150){ days += 10; }
    if(throughput>100){ days += 8; }
    if(gpu==='H100'){ days += 5; }
    days += 7 * regions.length;
    days += 10 * compliance.length;
    if(checked('autoscale')){ days += 7; }
    days += 4 * endpoints.length;
    days += 3 * sdks.length;
    document.getElementById('estDays').textContent = `~${days} days`;
    // Summary
    const summary = [
      `Framework: ${framework||'—'}`,
      `Size: ${size||'—'}`,
      `Modality: ${modality||'—'}`,
      `Quantization: ${quant||'—'}`,
      `Finetune: ${finetune||'—'}`,
      `GPU: ${gpu||'—'}`,
      `Scrape: text ${scrapeText.length}, image ${scrapeImage.length}`,
    ];
    document.getElementById('selSummary').innerHTML = summary.map(s=>`<li>${s}</li>`).join('');
  }
  form.addEventListener('change', recalc);
  recalc();
})();
</script>
{% endblock %}
